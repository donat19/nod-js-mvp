<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoHub - Home</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <nav class="navbar">
            <div class="container">
                <h1 class="main_logo">AutoHub</h1>
                <div class="right-section">
                <div class="search-wrapper">
                    <input type="text" placeholder="Search cars..." class="search-input">
                    <button class="search-btn"><img src="img/search.svg" alt="Search"></button>
                </div>
                <a href="/login" class="login-button"><img src="img/login.svg" alt="Login"></a>
                </div>
            </div>
        </nav>
    </header>
    <main>
        <div class="header-content">
            <img src="img/2101 copy_large.jpg" class="main_image">
            <h2 class="slogan">Find your next car</h2>
            <p class="header-time">4 days ago</p>
            <p class="header-name">Audi RS6 Avant Perfomance Quattro</p>
        </div>
        
        <!-- Advanced Filter System -->
        <div class="filter-system">
            <div class="filter-header">
                <h3>Find Your Perfect Car</h3>
                <button id="toggleFilters" class="toggle-filters-btn">
                    <span id="filterToggleText">Advanced Filters</span>
                    <span id="filterToggleIcon">▼</span>
                </button>
            </div>
            
            <!-- Basic Filters (Always Visible) -->
            <div class="basic-filters">
                <div class="filter-row">
                    <div class="filter-item">
                        <label for="searchInput">Search</label>
                        <input type="text" id="searchInput" placeholder="Search by make, model, or title...">
                    </div>
                    
                    <div class="filter-item">
                        <label for="makeFilter">Make</label>
                        <select id="makeFilter">
                            <option value="">All Makes</option>
                        </select>
                    </div>
                    
                    <div class="filter-item">
                        <label for="modelFilter">Model</label>
                        <select id="modelFilter">
                            <option value="">All Models</option>
                        </select>
                    </div>
                    
                    <div class="filter-item">
                        <label for="locationFilter">Location</label>
                        <select id="locationFilter">
                            <option value="">All Locations</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Advanced Filters (Collapsible) -->
            <div class="advanced-filters" id="advancedFilters" style="display: none;">
                <div class="filter-row">
                    <div class="filter-item">
                        <label for="priceMin">Min Price</label>
                        <input type="number" id="priceMin" placeholder="0" min="0">
                    </div>
                    
                    <div class="filter-item">
                        <label for="priceMax">Max Price</label>
                        <input type="number" id="priceMax" placeholder="No limit" min="0">
                    </div>
                    
                    <div class="filter-item">
                        <label for="yearMin">Min Year</label>
                        <select id="yearMin">
                            <option value="">Any Year</option>
                        </select>
                    </div>
                    
                    <div class="filter-item">
                        <label for="yearMax">Max Year</label>
                        <select id="yearMax">
                            <option value="">Any Year</option>
                        </select>
                    </div>
                </div>
                
                <div class="filter-row">
                    <div class="filter-item">
                        <label for="mileageMax">Max Mileage</label>
                        <select id="mileageMax">
                            <option value="">Any Mileage</option>
                            <option value="25000">Under 25,000 mi</option>
                            <option value="50000">Under 50,000 mi</option>
                            <option value="75000">Under 75,000 mi</option>
                            <option value="100000">Under 100,000 mi</option>
                            <option value="150000">Under 150,000 mi</option>
                        </select>
                    </div>
                    
                    <div class="filter-item">
                        <label for="transmissionFilter">Transmission</label>
                        <select id="transmissionFilter">
                            <option value="">Any Transmission</option>
                            <option value="automatic">Automatic</option>
                            <option value="manual">Manual</option>
                            <option value="cvt">CVT</option>
                        </select>
                    </div>
                    
                    <div class="filter-item">
                        <label for="fuelTypeFilter">Fuel Type</label>
                        <select id="fuelTypeFilter">
                            <option value="">Any Fuel Type</option>
                            <option value="gasoline">Gasoline</option>
                            <option value="diesel">Diesel</option>
                            <option value="hybrid">Hybrid</option>
                            <option value="electric">Electric</option>
                        </select>
                    </div>
                    
                    <div class="filter-item">
                        <label for="bodyTypeFilter">Body Type</label>
                        <select id="bodyTypeFilter">
                            <option value="">Any Body Type</option>
                            <option value="sedan">Sedan</option>
                            <option value="suv">SUV</option>
                            <option value="hatchback">Hatchback</option>
                            <option value="coupe">Coupe</option>
                            <option value="wagon">Wagon</option>
                            <option value="convertible">Convertible</option>
                            <option value="pickup">Pickup Truck</option>
                            <option value="van">Van</option>
                        </select>
                    </div>
                </div>
                
                <div class="filter-row">
                    <div class="filter-item">
                        <label for="conditionFilter">Condition</label>
                        <select id="conditionFilter">
                            <option value="">Any Condition</option>
                            <option value="new">New</option>
                            <option value="like-new">Like New</option>
                            <option value="excellent">Excellent</option>
                            <option value="good">Good</option>
                            <option value="fair">Fair</option>
                        </select>
                    </div>
                    
                    <div class="filter-item">
                        <label for="colorFilter">Color</label>
                        <select id="colorFilter">
                            <option value="">Any Color</option>
                            <option value="white">White</option>
                            <option value="black">Black</option>
                            <option value="silver">Silver</option>
                            <option value="gray">Gray</option>
                            <option value="red">Red</option>
                            <option value="blue">Blue</option>
                            <option value="green">Green</option>
                            <option value="brown">Brown</option>
                            <option value="yellow">Yellow</option>
                            <option value="orange">Orange</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    
                    <div class="filter-item">
                        <label for="sortBy">Sort By</label>
                        <select id="sortBy">
                            <option value="newest">Newest First</option>
                            <option value="oldest">Oldest First</option>
                            <option value="price-low">Price: Low to High</option>
                            <option value="price-high">Price: High to Low</option>
                            <option value="mileage-low">Mileage: Low to High</option>
                            <option value="year-new">Year: Newest First</option>
                        </select>
                    </div>
                    
                    <div class="filter-item">
                        <label for="showOnly">Show Only</label>
                        <select id="showOnly">
                            <option value="">All Listings</option>
                            <option value="with-images">With Images</option>
                            <option value="verified">Verified Sellers</option>
                            <option value="recent">Posted This Week</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Filter Actions -->
            <div class="filter-actions">
                <button id="applyFilters" class="apply-filters-btn">Apply Filters</button>
                <button id="clearFilters" class="clear-filters-btn">Clear All</button>
                <span id="resultsCount" class="results-count">Loading...</span>
            </div>
        </div>
        <h2 class="text-main"><span>AutoHub</span> - Buy. Sell. Drive.</h2>
        <div class="container">
            <h3 class="text-added">Recently Added</h3>
        </div>
        <div class="articles" id="recentAds">
            <!-- Loading state -->
            <div class="loading-state" style="text-align: center; padding: 40px; color: #666; width: 100%;">
                <div style="font-size: 24px; margin-bottom: 10px;">🔄</div>
                <p>Loading recent ads...</p>
            </div>
        </div>
    </main>
    <footer>
        <div class="container">
            <h3 class="footer-logo">AutoHub</h3>
            <ul class="footer-links">
                <li><a href="#">Privacy Policy</a></li>
                <li><a href="#">Accomodation Rules</a></li>
                <li><a href="#">Contacts</a></li>
                <li><p class="footer-copy">©2025 AutoHub | All rights reserved</p></li>
            </ul>
            <div class="social-icons">
                <a href="#"><img src="img/Instagram_icon.png" alt="Instagram"></a>
                <a href="#"><img src="img/Facebook_icon.png" alt="Facebook"></a>
                <a href="#"><img src="img/Telegram_icon.png" alt="Telegram"></a>
                <a href="#"><img src="img/Youtube_icon.png" alt="YouTube"></a>
            </div>
        </div>
    </footer>

    <script>
        // Check if user is logged in and update navigation
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Use SessionManager for better token handling
                if (typeof SessionManager !== 'undefined') {
                    const sessionResult = await SessionManager.checkSession();
                    
                    if (sessionResult.authenticated && sessionResult.user) {
                        // User is logged in, replace login button with user menu
                        const loginButton = document.querySelector('.login-button');
                        if (loginButton) {
                            const userName = sessionResult.user.name || sessionResult.user.phone || 'User';
                            
                            loginButton.outerHTML = `
                                <div class="user-menu-container">
                                    <button class="user-button" onclick="toggleUserMenu()">
                                        ${userName} ▼
                                    </button>
                                    <div class="dropdown-menu" id="userDropdown">
                                        <a href="/dashboard">Dashboard</a>
                                        <a href="/my-ads">My Ads</a>
                                        <a href="/settings">Settings</a>
                                        ${sessionResult.user.isAdmin ? '<a href="/admin">Admin Panel</a>' : ''}
                                        <a href="#" onclick="logout()">Logout</a>
                                    </div>
                                </div>
                            `;
                        }
                    }
                } else {
                    // Fallback for direct fetch if SessionManager is not available
                    const response = await fetch('/api/auth/session', {
                        method: 'GET',
                        credentials: 'include',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    const data = await response.json();
                    
                    if (data.authenticated && data.user) {
                        // User is logged in, replace login button with user menu
                        const loginButton = document.querySelector('.login-button');
                        if (loginButton) {
                            const userName = data.user.name || data.user.phone || 'User';
                            
                            loginButton.outerHTML = `
                                <div class="user-menu-container">
                                    <button class="user-button" onclick="toggleUserMenu()">
                                        ${userName} ▼
                                    </button>
                                    <div class="dropdown-menu" id="userDropdown">
                                        <a href="/dashboard">Dashboard</a>
                                        <a href="/my-ads">My Ads</a>
                                        <a href="/settings">Settings</a>
                                        ${data.user.isAdmin ? '<a href="/admin">Admin Panel</a>' : ''}
                                        <a href="#" onclick="logout()">Logout</a>
                                    </div>
                                </div>
                            `;
                        }
                    }
                }
            } catch (error) {
                console.error('Error checking user session:', error);
            }
        });

        // Toggle user menu dropdown
        function toggleUserMenu() {
            const dropdown = document.getElementById('userDropdown');
            if (dropdown) {
                dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const userMenuContainer = document.querySelector('.user-menu-container');
            const dropdown = document.getElementById('userDropdown');
            
            if (userMenuContainer && dropdown && !userMenuContainer.contains(event.target)) {
                dropdown.style.display = 'none';
            }
        });

        // Logout function
        async function logout() {
            try {
                if (typeof SessionManager !== 'undefined') {
                    await SessionManager.logout();
                } else {
                    // Fallback logout
                    await fetch('/api/auth/logout', {
                        method: 'POST',
                        credentials: 'include'
                    });
                }
                window.location.reload();
            } catch (error) {
                console.error('Logout error:', error);
                window.location.reload();
            }
        }
    </script>
                        
                        // Create new user menu element
                        const userMenuContainer = document.createElement('div');
                        userMenuContainer.className = 'user-menu-container';
                        userMenuContainer.style.cssText = 'position: relative;';
                        
                        userMenuContainer.innerHTML = `
                            <button class="user-button" style="background: transparent; border: none; color: white; font-family: 'Poppins', sans-serif; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                                <img src="img/login.svg" alt="User" style="width: 20px; height: 20px;">
                                <span>${userName}</span>
                                <span style="font-size: 12px;">▼</span>
                            </button>
                            <div class="dropdown-menu" style="position: absolute; top: 100%; right: 0; background: white; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); min-width: 200px; z-index: 1000; display: none;">
                                <a href="/my-ads" style="display: block; padding: 12px 16px; text-decoration: none; color: #333; border-bottom: 1px solid #f0f0f0;">🚗 My Ads</a>
                                <a href="/chats" style="display: block; padding: 12px 16px; text-decoration: none; color: #333; border-bottom: 1px solid #f0f0f0;">💬 Chats</a>
                                <a href="/dashboard" style="display: block; padding: 12px 16px; text-decoration: none; color: #333; border-bottom: 1px solid #f0f0f0;">📊 Dashboard</a>
                                <a href="/settings" style="display: block; padding: 12px 16px; text-decoration: none; color: #333; border-bottom: 1px solid #f0f0f0;">⚙️ Settings</a>
                                <a href="#" onclick="logout()" style="display: block; padding: 12px 16px; text-decoration: none; color: #BD3432;">🚪 Logout</a>
                            </div>
                        `;
                        
                        // Replace the login button with the user menu
                        loginButton.parentNode.replaceChild(userMenuContainer, loginButton);
                        
                        // Add dropdown functionality
                        const userButton = userMenuContainer.querySelector('.user-button');
                        const dropdownMenu = userMenuContainer.querySelector('.dropdown-menu');
                        
                        userButton.addEventListener('click', function(e) {
                            e.stopPropagation();
                            dropdownMenu.style.display = dropdownMenu.style.display === 'block' ? 'none' : 'block';
                        });
                        
                        // Close dropdown when clicking outside
                        document.addEventListener('click', function() {
                            dropdownMenu.style.display = 'none';
                        });
                    }
                }
            } catch (error) {
                console.log('User not logged in or session check failed');
            }
        });

        // Logout function
        async function logout() {
            try {
                await fetch('/api/auth/logout', {
                    method: 'POST',
                    credentials: 'include'
                });
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                window.location.reload();
            } catch (error) {
                console.error('Logout error:', error);
                window.location.reload();
            }
        }
    </script>
    
    <!-- Load advanced filter system -->
    <script src="js/advancedFilters.js"></script>
    
    <!-- Load recent ads functionality -->
    <script src="js/recentAds.js"></script>
</body>
</html>